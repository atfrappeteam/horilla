{% extends "index.html" %}
{% load i18n %}
{% load static %}
{% load basefilters %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow p-4">
        <h1 class="mb-4 text-center">{% translate "Interview Rounds" %}</h1>

        <div class="d-flex justify-content-between mb-3">
            <div id="tableControls"></div>
            <button type="button" class="oh-btn oh-btn--secondary btn-lg" id="openModal">
                {% translate "Create New Interview Round" %}
            </button>
        </div>

        <!-- Create Modal -->
        <div class="modal fade" id="createInterviewRoundModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-md">
                <div class="modal-content">
                    <div class="modal-header oh-modal-header">
                        <h5 class="modal-title oh-modal-title">{% translate "Create New Interview Round" %}</h5>
                        <button type="button" class="btn-close oh-close-button" data-bs-dismiss="modal"
                                aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body oh-modal-body">
                        <div id="modal-form-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal fade" id="editInterviewRoundModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-md">
                <div class="modal-content">
                    <div class="modal-header oh-modal-header">
                        <h5 class="modal-title oh-modal-title">{% translate "Edit Interview Round" %}</h5>
                        <button type="button" class="btn-close oh-close-button" data-bs-dismiss="modal"
                                aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body oh-modal-body">
                        <div id="edit-modal-form-container"></div>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="csrfToken" value="{{ csrf_token }}">
        <!-- Table -->
        <div class="card shadow p-3">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped w-100" id="interviewTable">
                        <thead class="table-dark">
                        <tr>
                            <th>{% translate "Round Name" %}</th>
                            <th>{% translate "Expected Skills" %}</th>
                            <th>{% translate "Designation" %}</th>
                            <th>{% translate "Actions" %}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for round in interview_rounds %}
                        <tr>
                            <td>{{ round.round_name }}</td>
                            <td>{{ round.expected_skills.all|join:", " }}</td>
                            <td>{{ round.designation }}</td>
                            <td>
                                <div style="display:inline-flex;">
                                    <button type="button" class="oh-btn oh-btn--warning me-1 openEditModalBtn"
                                            data-id="{{ round.id }}">
                                        {% translate "Edit" %}
                                    </button>
                                    <button type="button"
                                            class="oh-btn oh-btn--danger delete-btn"
                                            data-id="{{ round.pk }}">
                                        {% translate "Delete" %}
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">{% translate "No interview rounds found." %}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
    .modal {
        display: none;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1055 !important;
    }
    .modal-content {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0px 15px 30px rgba(0, 0, 0, 0.3);
        padding: 15px;
        transition: all 0.3s ease-in-out;
    }
    .oh-modal-header {
        border-bottom: 1px solid #dee2e6;
        padding: 1rem 1.5rem;
        border-radius: 12px 12px 0 0;
        background-color: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .oh-modal-title {
        font-size: 1.25rem;
        font-weight: 500;
    }
    .oh-modal-body {
        padding: 1.5rem;
    }
    .modal-dialog {
        position: fixed;
        top: 12% !important;
        left: 50%;
        transform: translate(-50%, 0);
        width: 60%;
        max-width: 700px;
        z-index: 1060 !important;
    }
    .card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        padding: 15px;
        margin-top: 20px;
    }
    .table {
        width: 100%;
        margin-top: 10px;
    }
    .table th {
        background-color: #343a40 !important;
        color: white !important;
        text-align: center;
    }
    .table td {
        text-align: center;
        vertical-align: middle;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f9f9f9;
    }
    .table-responsive {
        overflow-x: auto;
    }
    .oh-btn {
        display: inline-block;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: background-color 0.3s;
    }

    .oh-btn--secondary {
        background-color: #dc3545;
        color: white;
    }

    .oh-btn--secondary:hover {
        background-color: #c82333;
    }

    .oh-btn--warning {
        background-color: #ffc107;
        color: #212529;
    }

    .oh-btn--warning:hover {
        background-color: #ffca2c;
    }

    .oh-btn--danger {
        background-color: #dc3545;
        color: white;
    }

    .oh-btn--danger:hover {
        background-color: #c82333;
    }

    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        padding-top: 1em;
        padding-bottom:1em;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.5em 1em;
        margin-left: 2px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background-color: #f0f0f0;
    }

    .oh-close-button {
        background: none;
        border: none;
        font-size: 1.5rem;
        line-height: 1;
        opacity: .5;
    }

    .oh-close-button:hover {
        opacity: .75;
    }
</style>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function () {
    const createInterviewRoundModal = $("#createInterviewRoundModal");
    const modalFormContainer = $("#modal-form-container");
    const openModalBtn = $("#openModal");
    const interviewTable = $("#interviewTable");

    // Open modal and load form
    openModalBtn.on("click", () => {
        $.get("{% url 'create-interview-round' %}")
            .done((data) => {
                modalFormContainer.html(data);
                createInterviewRoundModal.modal("show");
            })
            .fail(() => {
                console.error("Error fetching form data.");
            });
    });

    // Close modal
    $(document).on("click", ".btn-close", () => {
        createInterviewRoundModal.modal("hide");
    });

    // Handle form submission via AJAX
    $(document).on("submit", "#create-interview-form", function (e) {
        e.preventDefault();

        const form = $(this);
        const url = form.attr("action");
        const formData = form.serialize();

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            headers: {
                "X-CSRFToken": getCookie("csrftoken")
            },
            success: function (response) {
                if (response.success) {
                    Swal.fire("Success!", "Interview round created successfully.", "success").then(() => {
                        location.reload(); // Refresh page to update table
                    });
                } else {
                    modalFormContainer.html(response.html); // Re-render form with validation errors
                }
            },
            error: function () {
                Swal.fire("Error!", "Something went wrong. Please try again.", "error");
            }
        });
    });

    // Initialize DataTable
    const table = interviewTable.DataTable({
        language: {
            url: `//cdn.datatables.net/plug-ins/1.11.5/i18n/{{ LANGUAGE_CODE }}.json`
        },
        dom: 'lf<"table-responsive"t>ip',
    });

    // Move table controls to a custom div
    $('#tableControls').html(table.settings().container().find('.dataTables_length, .dataTables_filter'));
});


    $(document).on("click", ".openEditModalBtn", function () {
        const roundId = $(this).data("id");
        const url = "{% url 'edit_interview_round' 0 %}".replace("0", roundId);

        $.get(url, function (data) {
            $("#edit-modal-form-container").html(data);
            $("#editInterviewRoundModal").modal("show");
        }).fail(function () {
            alert("Failed to load the edit form.");
        });
    });

    $.ajaxSetup({
        headers: {
            "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val()
        }
    });

    $(document).on("submit", "#edit-interview-form", function (e) {
        e.preventDefault();
        const form = $(this);
        const url = form.attr("action") || window.location.href;
        const data = form.serialize();

        $.post(url, data, function (response) {
            if (response.success) {
                $("#editInterviewRoundModal").modal("hide");
                location.reload();
            } else {
                alert("Update failed.");
                console.log(response.errors);
            }
        }).fail(function () {
            alert("Error while submitting the form.");
        });
    });

$(document).on('click', '.delete-btn', function () {
    const roundId = $(this).data('id');

    Swal.fire({
        text: "Are you sure you want to delete this interview round?",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#008000",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes",
        cancelButtonText: "No",
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/recruitment/interview-round/delete/${roundId}/`,
                type: "POST",
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function (response) {
                    if (response.success) {
                        Swal.fire("Deleted!", "The interview round has been deleted.", "success").then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire("Error", "Delete failed. " + response.error || "", "error");
                    }
                },
                error: function (xhr) {
                    console.error("AJAX Error:", xhr.status, xhr.responseText);
                    Swal.fire("Error", "Something went wrong while deleting.", "error");
                }
            });
        }
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

window.onerror = function (message, source, lineno, colno, error) {
    console.log("Global JS Error:", message);
};

</script>
{% endblock %}

{% load static %}
{% load basefilters %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />

<style>
    .star-rating {
        font-size: 1.5rem;
        color: #ddd;
        cursor: pointer;
    }

    .star-rating .bi-star-fill {
        color: gold;
    }
    .form-error {
        color: red;
        font-size: 0.9rem;
        margin-top: 4px;
    }
</style>

<div class="container mt-4">
    <form method="post" action="{% url 'create-interview-feedback' %}" id="feedbackForm">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="form-group mb-3">
            {{ form.interview.label_tag }}
            {{ form.interview }}
            {% if form.interview.errors %}
                <div class="form-error">{{ form.interview.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group mb-3" id="round-group" style="display:none;">
            <label>Interview Round:</label>
            <p id="round-text" class="form-control-plaintext"></p>
            {{ form.interview_round }}
        </div>

        <div class="form-group mb-3" id="interviewer-group" style="display:none;">
            <label>Interviewer:</label>
            <p id="interviewer-text" class="form-control-plaintext"></p>
            {{ form.interviewer }}
        </div>

        {% for field in form %}
            {% if field.name in skills %}
                <div class="form-group mb-3">
                    <label>{{ field.label }}</label>
                    <div class="star-rating" data-field="{{ field.name }}">
                        {% for i in "12345" %}
                            <i class="bi bi-star" data-value="{{ i }}"></i>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="{{ field.name }}" id="id_{{ field.name }}" />
                </div>
            {% endif %}
        {% endfor %}

        <div class="form-group mb-3">
            {{ form.remark.label_tag }}
            {{ form.remark }}
            {% if form.remark.errors %}
                <div class="form-error">{{ form.remark.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group mb-3">
            {{ form.result.label_tag }}
            {{ form.result }}
            {% if form.result.errors %}
                <div class="form-error">{{ form.result.errors.0 }}</div>
            {% endif %}
        </div>

        <button type="submit" class="btn btn-primary">Submit Feedback</button>
    </form>
</div>

<script>
    function initializeFeedbackForm() {
        const roundGroup = document.getElementById("round-group");
        const interviewerGroup = document.getElementById("interviewer-group");

        const interviewSelect = document.getElementById("id_interview");
        const roundField = document.getElementById("id_interview_round");
        const interviewerField = document.getElementById("id_interviewer");

        if (interviewSelect) {
            interviewSelect.addEventListener("change", function () {
                const interviewId = this.value;
                if (interviewId) {
                    fetch(`/recruitment/get-interview-details/${interviewId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.round_id) {
                                roundField.disabled = false;
                                roundField.value = data.round_id;

                                const roundText = roundField.options[roundField.selectedIndex].text;
                                document.getElementById("round-text").textContent = roundText;

                                roundGroup.style.display = "block";
                            }

                            if (data.interviewer_ids.length > 0) {
                                interviewerField.disabled = false;
                                interviewerField.value = data.interviewer_ids[0];

                                const interviewerText = interviewerField.options[interviewerField.selectedIndex].text;
                                document.getElementById("interviewer-text").textContent = interviewerText;

                                interviewerGroup.style.display = "block";
                            }
                        });
                }
            });
        }

        // Star rating
        document.querySelectorAll(".star-rating").forEach(function (ratingDiv) {
            const fieldName = ratingDiv.dataset.field;
            const stars = ratingDiv.querySelectorAll("i");
            const hiddenInput = document.getElementById(`id_${fieldName}`);

            stars.forEach(function (star) {
                star.addEventListener("click", function () {
                    const ratingValue = parseInt(this.dataset.value);
                    hiddenInput.value = ratingValue;

                    stars.forEach(s => {
                        s.classList.remove("bi-star-fill");
                        s.classList.add("bi-star");
                    });

                    for (let i = 0; i < ratingValue; i++) {
                        stars[i].classList.remove("bi-star");
                        stars[i].classList.add("bi-star-fill");
                    }
                });
            });
        });


</script>
